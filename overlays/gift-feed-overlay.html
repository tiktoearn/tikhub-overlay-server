
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    
    <!-- TikHub App Logo for demo -->
    <link rel="icon" type="image/png" href="/logo.png">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.8);
            margin: 0;
            padding: 10px;
        }

        #chatContainer {
            width: 100%;
            height: calc(100vh - 20px);
            overflow-y: hidden;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateX(-100px);
            }
            60% {
                opacity: 1;
                transform: translateX(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .giftItem {
            display: flex;
            align-items: center;
            background: rgba(80, 80, 80, 0.9);
            border-radius: 10px;
            padding: 6px 12px;
            animation: slideIn 0.3s ease-out;
            min-height: 40px;
            width: 380px;
            min-width: 380px;
            max-width: 380px;
            box-sizing: border-box;
        }

        .profileImage {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            margin-right: 10px;
            object-fit: cover;
        }

        .giftContent {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .username {
            color: #c084fc;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 1px;
        }

        .giftText {
            color: #ffffff;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .giftRight {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .repeatCount {
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .giftImage {
            width: 32px;
            height: 32px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .fadeOut {
            animation-name: smoothFadeout;
            animation-duration: 1s;
            animation-fill-mode: forwards;
        }

        @keyframes smoothFadeout {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes redBlinkAnimation {
            0% {
                background-color: transparent;
            }

            25% {
                background-color: rgba(211, 65, 60, 0.56);
            }

            50% {
                background-color: rgba(211, 65, 60, 0.56);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes redGlowAnimation {
            0% {
                background-color: transparent;
            }

            10% {
                background-color: rgba(211, 65, 60, 0.56);
            }

            100% {
                background-color: transparent;
            }
        }

        .slideIn {
            animation-name: chatMessageOpacityIntro, chatMessageSlideIntro;
            animation-duration: 0.5s, 0.5s;
            animation-iteration-count: 1, 1;
        }

        @keyframes foundAnimation {
            0% {
                background-color: transparent;
            }

            25% {
                background-color: rgba(70, 203, 52, 0.56);
            }

            50% {
                background-color: rgba(70, 203, 52, 0.56);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes foundAnimationEnd {
            0% {
                background-color: transparent;
            }

            100% {
                background-color: rgba(70, 203, 52, 0.56);
            }
        }

        .found {
            animation-name: foundAnimation, foundAnimationEnd, chatMessageOpacityIntro, chatMessageSlideIntro;
            animation-duration: 0.5s, 0.3s, 0.5s, 0.5s;
            animation-iteration-count: 3, 1, 1, 1;
            animation-delay: 0s, 1.5s, 0s, 0s;
            animation-fill-mode: none, forwards, none, none;
        }

        @keyframes repeatRefreshAnimation {
            0% {
                transform: scale(1.5, 1.5);
            }

            100% {
                transform: scale(1.0, 1.0);
            }
        }

        .repeatRefresh {
            animation-name: repeatRefreshAnimation;
            animation-duration: 0.5s;
            animation-fill-mode: backwards;
        }
    </style>

    <!-- Custom Gift Feed Script -->
    <script>
        // Default settings
        var settings = {
            gifts_minValue: 0,
            gifts_showPictures: true,
            gifts_mini: false,
            gifts_usernameRgb: true,
            gifts_slideEffect: true,
            gifts_hideAfter: 0,
            gifts_commentColor: '#ffffff',
            gifts_backgroundColor: 'transparent'
        };

        // Demo gift images - using placeholder service for reliable images
        const giftImages = {
            'Rose': 'https://placehold.co/50x50/ff6b9d/ffffff?text=ðŸŒ¹',
            'TikTok': 'https://placehold.co/50x50/000000/ffffff?text=TT',
            'Heart': 'https://placehold.co/50x50/ff4757/ffffff?text=â¤ï¸',
            'Lion': 'https://placehold.co/50x50/ffa502/ffffff?text=ðŸ¦',
            'Crown': 'https://placehold.co/50x50/ffd700/ffffff?text=ðŸ‘‘',
            'Galaxy': 'https://placehold.co/50x50/8e44ad/ffffff?text=ðŸŒŒ',
            'Doughnut': 'https://placehold.co/50x50/ff9ff3/ffffff?text=ðŸ©',
            'Finger Heart': 'https://placehold.co/50x50/ff6b81/ffffff?text=ðŸ«°',
            'GG': 'https://placehold.co/50x50/70a1ff/ffffff?text=GG',
            'Ice Cream': 'https://placehold.co/50x50/fbc531/ffffff?text=ðŸ¦',
            'Love': 'https://placehold.co/50x50/ff4757/ffffff?text=ðŸ’•',
            'Panda': 'https://placehold.co/50x50/535c68/ffffff?text=ðŸ¼'
        };

        // Default avatar (TikHub logo)
        const defaultAvatar = 'logo.png';
        
        // Fallback for image errors
        const nothumb = defaultAvatar;

        var chatContainer = null;
        var template = null;
        var userIdColorMappings = {};

        function rndColorPart(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min);
        }

        function cloneTemplate() {
            chatContainer = $("#chatContainer");
            template = $(".giftItem").first().clone();
            template.css("display", "none");
            $(".giftItem").remove();
        }

        function enforceMessageLimit() {
            const messages = $(".giftItem");
            if (messages.length > 50) {
                messages.slice(0, 25).remove();
            }
        }

        function ensureRgbColor(userId) {
            if (!userIdColorMappings[userId]) {
                userIdColorMappings[userId] = `rgba(${rndColorPart(100, 240)},${rndColorPart(100, 240)},${rndColorPart(100, 240)}, 1)`;
            }
            return userIdColorMappings[userId];
        }

        function handleGift(giftInfo) {
            if (!template || !chatContainer) return;
            enforceMessageLimit();

            let thisItem = template.clone();
            thisItem.css('display', 'flex');
            
            // Get gift image
            const giftImg = giftImages[giftInfo.giftName] || giftInfo.giftPictureUrl || giftInfo.giftImage || defaultAvatar;
            
            // Get user avatar (use app logo as default)
            const userAvatar = giftInfo.profilePictureUrl || defaultAvatar;
            
            thisItem.find(".profileImage").attr("src", userAvatar);
            thisItem.find(".giftImage").attr("src", giftImg);
            thisItem.find(".username").text(giftInfo.nickname || giftInfo.uniqueId);
            thisItem.find(".giftText").text(`Sent ${giftInfo.giftName}`);
            thisItem.attr("data-ts", new Date().getTime());

            // Update repeat count
            if (giftInfo.repeatCount > 1) {
                thisItem.find(".repeatCount").text(`x${giftInfo.repeatCount}`);
            } else {
                thisItem.find(".repeatCount").hide();
            }

            // Apply username color (purple/pink like original)
            if (settings.gifts_usernameRgb !== false) {
                const color = ensureRgbColor(giftInfo.userId || giftInfo.uniqueId);
                thisItem.find(".username").css("color", color);
            }

            // Slide animation
            if (settings.gifts_slideEffect !== false) {
                thisItem.addClass("slideIn");
            }

            // Add to top so newest gifts appear first
            chatContainer.prepend(thisItem);
            
        }

        // Demo mode with simulated gifts (matching original design examples)
        const demoGifts = [
            { userId: 'user1', uniqueId: 'ExampleUser1', nickname: 'ExampleUser1', giftName: 'Doughnut', diamondCount: 10, repeatCount: 1 },
            { userId: 'user2', uniqueId: 'ExampleUser2', nickname: 'ExampleUser2', giftName: 'Finger Heart', diamondCount: 100, repeatCount: 1 },
            { userId: 'user3', uniqueId: 'ExampleUser1', nickname: 'ExampleUser1', giftName: 'GG', diamondCount: 50, repeatCount: 1 },
            { userId: 'user4', uniqueId: 'RichGuy', nickname: 'RichGuy', giftName: 'Lion', diamondCount: 29999, repeatCount: 1 },
            { userId: 'user5', uniqueId: 'Streamer', nickname: 'Streamer', giftName: 'Crown', diamondCount: 1000, repeatCount: 2 },
            { userId: 'user6', uniqueId: 'GalaxyFan', nickname: 'GalaxyFan', giftName: 'Galaxy', diamondCount: 5000, repeatCount: 1 }
        ];

        // Check if demo mode is enabled (via URL parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const isDemoMode = urlParams.get('demo') === 'true';

        $(document).ready(() => {
            cloneTemplate();
            
            // Only show demo gifts if demo mode is enabled
            if (isDemoMode) {
                console.log('[Gift Feed] Ready - Demo mode active');
                
                // Simulate gifts every 3 seconds
                setInterval(() => {
                    const randomGift = demoGifts[Math.floor(Math.random() * demoGifts.length)];
                    handleGift(randomGift);
                }, 3000);
            } else {
                console.log('[Gift Feed] Ready - Real gift mode (no demo)');
            }
            
            // Always connect to WebSocket for real gifts
            const wsUrl = (location.origin.replace(/^http/, 'ws')) + '/ws/gift-bubbles';
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('[Gift Feed] Connected to WebSocket');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'gift' || data.event === 'gift') {
                        const source = data.giftData || data;
                        handleGift({
                            userId: source.userId || source.uniqueId,
                            uniqueId: source.uniqueId || source.nickname,
                            nickname: source.nickname || source.uniqueId,
                            giftName: source.giftName || source.gift?.giftName || 'Gift',
                            diamondCount: source.diamondCount || source.coins || 10,
                            repeatCount: source.repeatCount || 1,
                            giftPictureUrl: source.giftPictureUrl || source.giftImage,
                            profilePictureUrl: source.profilePictureUrl
                        });
                    }
                } catch (error) {
                    console.error('[Gift Feed] Error parsing message:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('[Gift Feed] WebSocket error:', error);
            };
        });
    </script>
</head>

<body>
    <div id="chatContainer">
        <div class="giftItem" style="display: none;">
            <img class="profileImage" onerror="this.src='logo.png'" />
            <div class="giftContent">
                <div class="username"></div>
                <div class="giftText"></div>
            </div>
            <div class="giftRight">
                <div class="repeatCount"></div>
                <img class="giftImage">
            </div>
        </div>
    </div>

</body>

</html>